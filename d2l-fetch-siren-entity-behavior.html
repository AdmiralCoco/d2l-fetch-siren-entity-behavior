<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-fetch/d2l-fetch.html">
<link rel="import" href="../siren-parser-import/siren-parser-global.html">

<script>
	'use strict';

	window.D2L = window.D2L || {};

	/*
	* Behavior for basic siren entity fetching which parses output on return.
	* @polymerBehavior
	*/
	window.D2L.FetchSirenEntityBehavior = {

		properties: {
			_clientTimeSkew: Number
		},

		_fetchEntity: function(url) {
			var request = new Request(url, {
				headers: new Headers({ Accept: 'application/vnd.siren+json' })
			});
			return this._makeRequest(request);
		},

		_fetchEntityWithToken: function(url, getToken, userUrl) {
			var tokenUrl = userUrl || url;
			if (url && typeof getToken === 'function' && tokenUrl) {
				return getToken(tokenUrl)
					.then(function(token) {
						if (typeof token === 'string') {
							var request = new Request(url, {
								headers: new Headers({
									Accept: 'application/vnd.siren+json',
									Authorization: 'Bearer ' + token
								})
							});
							return this._makeRequest(request);
						} else {
							throw new Error('token expected to be a string');
						}
					}.bind(this));
			}
			return Promise.reject(new Error('Invalid inputs'));
		},

		_makeRequest: function(request) {
			var self = this;
			return window.d2lfetch
				.fetch(request)
				.then(function(response) {
					if (response.ok) {
						var serverTimeUtc = new Date(response.headers.get('Date'));
						self._clientTimeSkew = serverTimeUtc - self._getCurrentTime();
						return response.json();
					}
					return Promise.reject(response.status);
				})
				.then(window.D2L.Hypermedia.Siren.Parse);
		},

		// this function is purely for mocking out while testing
		_getCurrentTime: function() {
			return new Date();
		}

	};

</script>
